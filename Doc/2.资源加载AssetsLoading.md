# èµ„æºåŠ è½½ç³»ç»Ÿæ–‡æ¡£

## ğŸŒŸ ç³»ç»Ÿç‰¹ç‚¹

### 1.ğŸš€ **åªæä¾›å¼‚æ­¥åŠ è½½**
- æœ¬æ¡†æ¶çš„èµ„æºåŠ è½½ç³»ç»Ÿå®Œå…¨åŸºäºå¼‚æ­¥æ“ä½œï¼Œæ—¨åœ¨ä¼˜åŒ–æ€§èƒ½å¹¶é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚
- æä¾›å¤šç§å¼‚æ­¥å›è°ƒæ–¹å¼ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š
  - ä»¥å‚æ•°æ–¹å¼ä¼ å…¥
  - YieldInstructionå¼å¼‚æ­¥åŠ è½½
  - äº‹ä»¶æ³¨å†Œ

### 2.ğŸ”§ **åŸºäºæ¥å£å¼€å‘**
- èµ„æºåŠ è½½ç³»ç»Ÿé‡‡ç”¨æ¥å£é©±åŠ¨è®¾è®¡ï¼ˆ`IAssetLoader`å’Œ`IAssetManager`ï¼‰ï¼Œä¾¿äºæ‰©å±•å’Œè‡ªå®šä¹‰ã€‚
- å¯æ— ç¼æ¥å…¥å…¶ä»–èµ„æºç®¡ç†å·¥å…·ï¼ˆä»¥æ¥å…¥ Unity Addressablesã€AssetBundleï¼‰ã€‚
- å¼€å‘è€…åªéœ€å®ç°æ¡†æ¶æä¾›çš„èµ„æºåŠ è½½æ¥å£ï¼Œå³å¯æ›¿æ¢é»˜è®¤å®ç°ã€‚

### 3.ğŸ“¦ **ç¦»æ•£åŒ–ç®¡ç†**
- ç¦»æ•£åŒ–çš„ç®¡ç†æ–¹å¼ï¼Œè®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºå½“å‰æƒ…æ™¯ä¸‹çš„èµ„æºè°ƒåº¦ï¼Œé¿å…å…¨å±€å¸è½½æŸä¸ªèµ„æºå¯¼è‡´æŠ¥é”™ã€‚
- èµ„æºåŠ è½½é€šè¿‡å®ä¾‹åŒ–çš„`IAssetLoader`ä½œä¸ºè½½ä½“ã€‚

### 4.âš¡ **èµ„æºå¼‚æ­¥åŠ è½½ & å…¨è·¯å¾„ä¸ºkey**
- æ¡†æ¶å†…è™½ç„¶æä¾›äº†åŒæ­¥åŠ è½½çš„æ–¹æ³•ï¼Œä½†ä¸ºäº†æ¥å£ç»Ÿä¸€å’ŒwebGLå¹³å°ä¸Šå…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€æœ‰æ¥å£æ–¹æ³•å†…æ²¡æœ‰åŒæ­¥åŠ è½½æ–¹æ³•ï¼Œåªåœ¨`IAssetLoader`å®ä¾‹å†…æä¾›äº†åŒæ­¥åŠ è½½æ–¹æ³•ã€‚
- åŒæ—¶`IAssetLoader`ä½¿ç”¨å…¨è·¯å¾„ä½œä¸ºèµ„æºåŠ è½½çš„keyã€‚å½“ç„¶ï¼Œå¦‚æœæ˜¯è‡ªå·±å®ç°çš„`IAssetLoader`å¯ä»¥é€‰æ‹©å…¶ä»–å«ä¹‰çš„stringï¼Œåªéœ€è¦è‡ªè¡Œè½¬æ¢ä¼ å…¥å‚æ•°å³å¯ã€‚
- ä½¿ç”¨`IAssetLoader`åŠ è½½æ—¶ï¼Œå€¼å¾—æ³¨æ„çš„æ¥å£å¦‚ä¸‹ï¼š
```csharp
namespace PowerCellStudio
{
    public interface IAssetLoader 
    {
        // å¸è½½å®ä¾‹å†…éƒ¨ç¼“å­˜ï¼Œå¹¶å°è¯•è®¡ç®—Bundleå¼•ç”¨è®¡æ•°
        public bool Release(string address);
        
        // æ£€æŸ¥èµ„æºæ˜¯å¦åœ¨åŠ è½½
        public bool IsLoading(string address);
        
        // å°†å›è°ƒä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè¿›è¡Œå¼‚æ­¥åŠ è½½
        public void LoadAsync<T>(string address, Action<T> onSuccess, Action onFail = null) where T : UnityEngine.Object;

        // ä»¥Taskçš„æ–¹å¼è¿›è¡Œå¼‚æ­¥åŠ è½½ï¼Œä¸å»ºè®®åœ¨WebGLä¸­ä½¿ç”¨
        public Task<T> LoadTask<T>(string address) where T : UnityEngine.Object;

        // ä»¥YieldInstructionçš„å½¢å¼è¿›è¡Œå¼‚æ­¥åŠ è½½ï¼Œä¹Ÿå¯ç”¨è¿”å›çš„LoaderYieldInstruction<T>æ³¨å†ŒåŠ è½½å®Œæˆäº‹ä»¶
        public LoaderYieldInstruction<T> LoadAsYieldInstruction<T>(string address) where T : UnityEngine.Object;

        // ç›´æ¥å°†é¢„åˆ¶ä½“ç”Ÿæˆä¸ºGameObjectæ”¾ç½®åœ¨åœºæ™¯å†…ï¼Œæ³¨æ„åœ¨Addressableæ¨¡å¼ä¸‹ï¼ŒonSuccesså¯èƒ½ä¼šåœ¨ç”Ÿæˆåçš„ä¸‹ä¸€å¸§æ‰æ‰§è¡Œ
        public void AsyncLoadNInstantiate(string address, Action<GameObject> onSuccess, Action onFail = null);
        
        // ç›´æ¥å°†é¢„åˆ¶ä½“ç”Ÿæˆä¸ºGameObjectå¹¶è®¾ç½®çˆ¶èŠ‚ç‚¹å†…ï¼Œæ³¨æ„åœ¨Addressableæ¨¡å¼ä¸‹ï¼ŒonSuccesså¯èƒ½ä¼šåœ¨ç”Ÿæˆåçš„ä¸‹ä¸€å¸§æ‰æ‰§è¡Œ
        public void AsyncLoadNInstantiate(string address, Transform parent, Action<GameObject> onSuccess, Action onFail = null);
    }
}
```

---

## ğŸ› ï¸ ä½¿ç”¨ç¤ºä¾‹

### 1.âœ¨ **åˆå§‹åŒ–èµ„æºåŠ è½½ç³»ç»Ÿ**
åˆå§‹åŒ–å·²ç»é›†æˆå†`SceneMainBase`å†…ï¼Œå¦‚æœæœ‰ç‰¹æ®Šæƒ…å†µéœ€è¦è‡ªè¡Œåˆå§‹åŒ–èµ„æºåŠ è½½ç³»ç»Ÿï¼Œä»¥ä¸‹ä¸ºç¤ºä¾‹:
```csharp
    public abstract class SceneMainBase : MonoBehaviour
    {        
        protected virtual void Awake()
        {
            DontDestroyOnLoad(gameObject);
            AssetUtils.Init(this, OnAssetUtilsInited);
        }

        private void OnAssetUtilsInited()
        {
            AssetLog.Log("AddressableManager Inited!");
            
            // èµ„æºç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥è¿›è¡Œèµ„æºåŠ è½½
            // do something
            StartGameLogic();
        }
    }
```

### 2.ğŸ“‚ **ç¦»æ•£åŒ–çš„ç®¡ç†æ–¹å¼**
æœ¬èµ„æºç®¡ç†ä½¿ç”¨äº†ç¦»æ•£åŒ–çš„ç®¡ç†æ–¹å¼ï¼Œå¼€å‘è€…é€šè¿‡`AssetUtils.SpawnLoader()`è·å¾—ä¸€ä¸ª`IAssetLoader`ã€‚

é€šè¿‡`IAssetLoader`åŠ è½½éœ€è¦çš„èµ„æºï¼ŒåŒæ—¶`IAssetLoader`ä¼šè‡ªåŠ¨ç¼“å­˜åŠ è½½çš„èµ„æºã€è®¡ç®—bundleå¼•ç”¨è®¡æ•°ã€‚

åœ¨ä¸éœ€è¦`IAssetLoader`æ—¶ï¼Œä½¿ç”¨`AssetUtils.DeSpawnLoader()`å›æ”¶`IAssetLoader`ï¼Œå¹¶è‡ªåŠ¨è§£é™¤èµ„æºç¼“å­˜å’Œè®¡ç®—bundleå¼•ç”¨è®¡æ•°ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä»¥ä¸Šçš„èµ„æºç¼“å­˜åªå±€é™äºæ‰€å½’å±çš„`IAssetLoader`çš„å†…éƒ¨ï¼Œå³æ¸…é™¤ä¸€ä¸ª`IAssetLoader`çš„èµ„æºï¼Œä¸ä¼šé€ æˆå…¶ä»–`IAssetLoader`å†…ç›¸åŒåŸå§‹èµ„æºçš„ç¼“å­˜å¤±æ•ˆã€‚

å› æ­¤`IAssetLoader`æœ€é€‚å®œçš„ä½¿ç”¨æ–¹å¼æ˜¯ï¼šå°†èµ„æºåŠ è½½æµç¨‹åˆ†å‰²ä¸ºæ•°ä¸ªå°çš„æƒ…æ™¯ï¼ˆæ‰“å¼€ä¸€ä¸ªUIã€å¼€å§‹ä¸€åœºæˆ˜æ–—ç­‰ï¼‰ï¼Œåœ¨æƒ…æ™¯å¼€å§‹æ—¶è·å–`IAssetLoader`ï¼Œåœ¨è¿™ä¸ªæƒ…æ™¯ç»“æŸæ—¶å›æ”¶`IAssetLoader`ã€‚

ä»¥ä¸‹ä¸ºä½¿ç”¨ä¾‹å­ï¼š

```csharp
public class ExampleBattleCase 
{
    private IAssetLoader _assetsLoader;

    // åœ¨å¼€å§‹æ—¶è·å–ä¸€ä¸ªIAssetLoaderï¼Œå¹¶ä½¿ç”¨å…¶åŠ è½½èµ„æº
    public void Init()
    {
        _assetsLoader = AssetUtils.SpawnLoader(this.GetType().name);
        LoadMap();
        LoadHero();
        CoroutineRuner.StartCoroutine(CreateEnemyPool());
    }

    // å½“æƒ…æ™¯é”€æ¯æ—¶ï¼Œå…ˆæ¸…é™¤åœºæ™¯å†…çš„èµ„æºï¼Œå›æ”¶IAssetLoaderï¼Œå°†_assetsLoaderç½®ç©ºé˜²æ­¢å›æ”¶çš„IAssetLoaderè¢«è°ƒç”¨
    public void Deinit()
    {
        ClearEnemyPool();
        AssetUtils.DeSpawnLoader(_assetsLoader);
        _assetsLoader = null;
    }

    private void LoadMap()
    {
        // å°†å›è°ƒä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè¿›è¡Œå¼‚æ­¥åŠ è½½
        _assetsLoader.LoadAsync<GameObject>("Assets/Res/exampleMapPath.prefab", OnMapLoaded);
    }

    private void OnMapLoaded(GameObject mapPrefab)
    {
        var map = GameObject.Instantiate(mapPrefab);
        Debug.log("map was Created!");
    }

    private void LoadHero()
    {
        // ç”¨è¿”å›çš„LoaderYieldInstruction<T>æ³¨å†ŒåŠ è½½å®Œæˆäº‹ä»¶
        var loadHandler = _assetsLoader.LoadAsYieldInstruction<GameObject>("Assets/Res/exampleHeroPath.prefab");
        loadHandler.onLoadSuccess += (prefab) =>
        {
            var hero = GameObject.Instantiate(prefab);
            Debug.log("Hero was Created!");
        }
    }

    private Stack<GameObject> _enemyPool;
    private GameObject _enemyPrefab;
    private IEnumertor CreateEnemyPool()
    {
        // ä»¥YieldInstructionçš„å½¢å¼è¿›è¡Œå¼‚æ­¥åŠ è½½
        var loadHandler = _assetsLoader.LoadAsYieldInstruction<GameObject>("Assets/Res/exampleEnemyPath.prefab");
        yield return loadHandler;
        var prefab = loadHandler.asset;
        if (!prefab) 
        {
            Debug.Error("Create Enemy Pool Failed!");
            yield break;
        }
        _enemyPrefab = prefab;
        _enemyPool = new Stack<GameObject>();
        for (var i = 0; i < 50; i++)
        {
            _enemyPool.Push(GameObject.Instantiate(prefab));
        }
        Debug.log("Enemy Pool was Created!");
    }

    private void ClearEnemyPool()
    {
        if(_enemyPool == null) return;
        _enemyPrefab = null;
        while(_enemyPool.Count > 0)
        {
            var item = _enemyPool.Pop();
            GameObject.Destroy(item);
        }
        _enemyPool = null;
    }
}
```

---

## ğŸ“– æ¡†æ¶å†…æä¾›çš„æƒ…æ™¯
æ¡†æ¶å·²ç»åœ¨UIç³»ç»Ÿã€å¯¹è±¡æ± ç³»ç»Ÿã€éŸ³é¢‘ç³»ç»Ÿã€é…ç½®è¡¨å·¥å…·ä¸­ï¼Œåœ¨é€‚å½“æ—¶åˆ»è·å–`IAssetLoader`å®ä¾‹ï¼Œå¼€å‘è€…ä¸€èˆ¬ä¸éœ€è¦å¦å¤–å»è·å–ã€‚

### 1.ğŸ–¼ï¸ **UIç³»ç»Ÿä¸­**
ä¾‹å¦‚åœ¨UIç³»ç»Ÿä¸­ï¼ŒUIä¼šåœ¨æ‰“å¼€æ—¶è‡ªåŠ¨è·å–ä¸€ä¸ª`IAssetLoader`:
```csharp
private IAssetLoader _assetsAssetLoader;
public IAssetLoader assetsAssetLoader => _assetsAssetLoader;

void IUIComponent.Open(object data)
{
    if(_assetsAssetLoader == null || !_assetsAssetLoader.spawned)
        _assetsAssetLoader = AssetUtils.SpawnLoader(this.GetType().Name);
    OnOpen(data);
}
```
å¼€å‘è€…åªéœ€åœ¨è¦åŠ è½½èµ„æºæ—¶è°ƒç”¨`assetsAssetLoader`å¯¹åº”æ¥å£å³å¯ã€‚

åœ¨UIé”€æ¯æ—¶ï¼Œ`assetsAssetLoader`ä¼šè‡ªåŠ¨å›æ”¶ï¼Œæ— éœ€åšé¢å¤–å¤„ç†ã€‚
```csharp
public virtual void OnUIDestroy()
{
    AssetUtils.DeSpawnLoader(_assetsAssetLoader);
    _assetsAssetLoader = null;
}
```

### 2.ğŸµ **å…¶ä»–ç³»ç»Ÿä¸­**
åœ¨å¯¹è±¡æ± ç³»ç»Ÿã€éŸ³é¢‘ç³»ç»Ÿã€é…ç½®è¡¨å·¥å…·ç­‰æƒ…æ™¯ï¼Œæ¨¡å—å†…åŠŸèƒ½ä¼šè‡ªè¡Œå¤„ç†å’Œ`IAssetLoader`çš„äº¤äº’ï¼Œå¼€å‘è€…æ— éœ€ç›´æ¥è°ƒç”¨`IAssetLoader`ï¼Œå› æ­¤ä¸åœ¨æ­¤ä»‹ç»ã€‚

---

## ğŸ”„ æ¥å…¥å…¶ä»–åŠ è½½å·¥å…·
å¦‚æœå¼€å‘è€…é€‰æ‹©ä½¿ç”¨å…¶ä»–èµ„æºç®¡ç†å·¥å…·ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼

### 1.ğŸ› ï¸ **å®ç°IAssetManager**
é¦–å…ˆå®ç°ä¸€ä¸ªç»§æ‰¿`IAssetManager`æ¥å£çš„ç±»ï¼ˆä»¥`ExampleAssetManager`ä¸ºä¾‹ï¼‰ï¼Œè¿™ä¸ªç±»ä¸»è¦çš„ä½œç”¨æ˜¯ä½œä¸º`IAssetLoader`çš„å®¹å™¨ï¼Œç”¨æ¥ç”Ÿæˆã€å›æ”¶`IAssetLoader`ã€‚
ä»¥ä¸‹ä¸º`IAssetManager`éœ€è¦å®ç°çš„æ¥å£ï¼š
```csharp
public interface IAssetManager
{
    // è·å¾—èµ„æºç®¡ç†å™¨åˆå§‹åŒ–çŠ¶æ€ï¼Œåœ¨åˆå§‹åŒ–æ˜¯ä¼šè¢«è°ƒç”¨
    AssetInitState initState {get;};

    // è·å¾—èµ„æºç®¡ç†å™¨åˆå§‹åŒ–çŠ¶æ€ï¼Œåœ¨åˆå§‹åŒ–æ˜¯ä¼šè¢«è°ƒç”¨
    float initProcess {get;};

    // èµ„æºç®¡ç†å™¨åˆå§‹åŒ–é€»è¾‘ï¼Œä¼ å…¥çš„coroutineRunnerä½œä¸ºå¼€å¯åç¨‹çš„èµ·ç‚¹ï¼ŒcallBackä¸€èˆ¬æ˜¯åˆå§‹åŒ–åæ¸¸æˆå¯åŠ¨é€»è¾‘
    public void Init(MonoBehaviour coroutineRunner, Action callBack);
    
    // è·å–IAssetLoaderçš„æ¥å£ï¼Œtagç”¨ä»¥åŒºåˆ†IAssetLoaderè¢«ä½¿ç”¨çš„åœºåˆ
    public IAssetLoader SpawnLoader(string tag);
    
    // å›æ”¶IAssetLoaderçš„æ¥å£ï¼Œåœ¨æ­¤å¤„ç†IAssetLoader.Deinit()ï¼Œå¹¶ä¸”å›æ”¶è‡³å¯¹è±¡æ± ä¸­
    public void DeSpawnLoader(IAssetLoader loader);
    
    // å›æ”¶æ‰€æœ‰IAssetLoaderï¼Œè¿™ä¸€æ­¥ä¼šå¸è½½å…¨éƒ¨åŠ è½½çš„èµ„æº
    public void DeSpawnAllLoader();
    
    // å›æ”¶å…·æœ‰ç‰¹å®štagçš„IAssetLoader
    public void DeSpawnLoaderByTag(string tag);

    // åŠ è½½åœºæ™¯
    public void LoadScene(string sceneName, Action onComplete, bool unLoadOtherScene = false);

    // å¸è½½åœºæ™¯
    public void UnloadScene(string name);
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹
1. **èµ„æºç®¡ç†ç”Ÿå‘½å‘¨æœŸ**
   - ç¡®ä¿åœ¨ä½¿ç”¨`IAssetLoader`æ—¶æ­£ç¡®åˆå§‹åŒ–å’Œå›æ”¶ï¼Œé¿å…èµ„æºæ³„æ¼ã€‚
2. **å¼‚æ­¥åŠ è½½çš„å›è°ƒå¤„ç†**
   - å¼‚æ­¥åŠ è½½çš„å›è°ƒå¯èƒ½ä¼šåœ¨ä¸‹ä¸€å¸§æ‰§è¡Œï¼Œéœ€æ³¨æ„é€»è¾‘é¡ºåºã€‚
3. **å…¨è·¯å¾„ä½œä¸ºKey**
   - ä½¿ç”¨å…¨è·¯å¾„ä½œä¸ºèµ„æºåŠ è½½çš„Keyï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®æ— è¯¯ã€‚