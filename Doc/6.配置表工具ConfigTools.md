# é…ç½®è¡¨å·¥å…·ä½¿ç”¨è¯´æ˜

## ğŸ“– ç®€ä»‹

æœ¬å·¥å…·æ˜¯ä¸€ä¸ªåŸºäº Unity çš„é…ç½®è¡¨ç®¡ç†å·¥å…·ï¼Œæ”¯æŒä» Excel æ–‡ä»¶ç”Ÿæˆé…ç½®æ•°æ®ï¼Œå¹¶ä»¥å¤šç§æ ¼å¼ï¼ˆå¦‚ ScriptableObjectã€JSONã€äºŒè¿›åˆ¶ï¼‰ä¿å­˜å’ŒåŠ è½½ã€‚å·¥å…·è¿˜æ”¯æŒæœ¬åœ°åŒ–åŠŸèƒ½ï¼Œå¯ä»¥å°†é…ç½®ä¸­çš„æœ¬åœ°åŒ–å­—ç¬¦ä¸²å¯¼å‡ºä¸º CSV æ–‡ä»¶ã€‚

## âš™ï¸ åŠŸèƒ½

1. **é…ç½®è¡¨ç”Ÿæˆ**
    - ä» Excel æ–‡ä»¶ç”Ÿæˆé…ç½®æ•°æ®ã€‚
    - æ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼ˆå¦‚ `int`ã€`float`ã€`string`ã€`bool` ç­‰ï¼‰ã€‚
    - æ”¯æŒæ•°ç»„ç±»å‹ï¼ˆå¦‚ `int[]`ã€`float[]` ç­‰ï¼‰ã€‚
    - æ”¯æŒæœ¬åœ°åŒ–å­—ç¬¦ä¸²å’Œèµ„æºå¼•ç”¨ã€‚
    - æ”¯æŒæ‰©å±•è‡ªå®šä¹‰ç±»å‹ã€‚

2. **å¤šç§å­˜å‚¨æ ¼å¼**
    - æ”¯æŒ ScriptableObjectã€JSON å’ŒäºŒè¿›åˆ¶æ ¼å¼ä¿å­˜é…ç½®æ•°æ®ã€‚
    - ScriptableObjectæ— æ³•æ”¯æŒéƒ¨åˆ†å¤æ‚ç»“æ„ï¼ˆä¾‹å¦‚List<Array>ï¼‰ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨JSON å’ŒäºŒè¿›åˆ¶æ ¼å¼ã€‚
    - å¯¹JSON å’ŒäºŒè¿›åˆ¶æ ¼å¼ï¼Œä¼šå¯¹ç”Ÿæˆçš„é…ç½®æ•°æ®èµ„äº§è¿›è¡ŒåŠ å¯†ï¼Œåœ¨åŠ è½½æ—¶è§£å¯†ã€‚

3. **æœ¬åœ°åŒ–æ”¯æŒ**
    - è‡ªåŠ¨æå–é…ç½®ä¸­çš„æœ¬åœ°åŒ–å­—ç¬¦ä¸²å’Œèµ„æºã€‚
    - å¯¼å‡ºæœ¬åœ°åŒ–æ•°æ®ä¸º CSV æ–‡ä»¶ã€‚

4. **å¼‚æ­¥åŠ è½½**
    - æ”¯æŒå¼‚æ­¥åŠ è½½é…ç½®æ•°æ®ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡é…ç½®è¡¨ã€‚

5. **è‡ªåŠ¨ä»£ç ç”Ÿæˆ**
    - è‡ªåŠ¨ç”Ÿæˆé…ç½®è¡¨å¯¹åº”çš„ C# ç±»å’Œç®¡ç†ç±»ã€‚

## ğŸ“‚ æ–‡ä»¶ç»“æ„

- `ConfigSettingWindow.cs`  
  æä¾›é…ç½®å·¥å…·çš„è®¾ç½®çª—å£ï¼Œå…è®¸ç”¨æˆ·è®¾ç½® Excel æ–‡ä»¶è·¯å¾„ã€ç”Ÿæˆçš„è„šæœ¬è·¯å¾„å’Œèµ„æºè·¯å¾„ã€‚

- `ConfigWriter.cs`  
  è´Ÿè´£ä» Excel æ–‡ä»¶ç”Ÿæˆé…ç½®è¡¨å¯¹åº”çš„ C# ç±»å’Œæ•°æ®æ–‡ä»¶ã€‚

- `ExcelReader.cs`  
  ç”¨äºè¯»å– Excel æ–‡ä»¶å¹¶è§£æå­—æ®µä¿¡æ¯ã€‚

- `ConfBase.cs`  
  å®šä¹‰é…ç½®è¡¨çš„åŸºç¡€ç±»å’Œé›†åˆç±»ã€‚

- `ConfAsyncLoadHandle.cs`  
  æä¾›å¼‚æ­¥åŠ è½½é…ç½®æ•°æ®çš„åŠŸèƒ½ã€‚

- `AssetRef` æ–‡ä»¶å¤¹  
  å®šä¹‰èµ„æºå¼•ç”¨ç±»å‹ï¼ˆå¦‚ `AudioRef`ã€`SpriteRef`ã€`LocalizationStringRef` ç­‰ï¼‰ã€‚

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### ğŸ“ 1. è®¾ç½®è·¯å¾„

æ‰“å¼€ Unity èœå• `Tools > Config > Config Setting Window`ï¼Œè®¾ç½®ä»¥ä¸‹è·¯å¾„ï¼š

![æ‰“å¼€Config Setting Window](img/ConfigToolMenuItem.png "Magic Gardens")

- **Excel æ–‡ä»¶è·¯å¾„**ï¼šå­˜æ”¾ Excel é…ç½®è¡¨çš„æ–‡ä»¶å¤¹è·¯å¾„ã€‚
- **è„šæœ¬æ–‡ä»¶è·¯å¾„**ï¼šç”Ÿæˆçš„ C# è„šæœ¬å­˜æ”¾è·¯å¾„ï¼Œæ­¤ä¸ºAssetsç›®å½•ä¸‹çš„ç›¸å¯¹è·¯å¾„ã€‚
- **èµ„æºæ–‡ä»¶è·¯å¾„**ï¼šç”Ÿæˆçš„é…ç½®èµ„æºå­˜æ”¾è·¯å¾„ï¼Œæ­¤ä¸ºAssetsç›®å½•ä¸‹çš„ç›¸å¯¹è·¯å¾„ã€‚

### ğŸ“œ 2. ç”Ÿæˆé…ç½®è¡¨

![Config Setting Window](img/ConfigSettingWindow.png "Magic Gardens")

åœ¨ `Config Setting Window` ä¸­ç‚¹å‡»ä»¥ä¸‹æŒ‰é’®ï¼š

- **Save Settings**ï¼šä¿å­˜å½“å‰è®¾ç½®ã€‚
- **Create Cs Files**ï¼šæ ¹æ® Excel æ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ C# ç±»ã€‚
- **Create Config Assets**ï¼šç”Ÿæˆé…ç½®è¡¨æ•°æ®æ–‡ä»¶ã€‚
- **Delete Config Assets**ï¼šåˆ é™¤å·²ç”Ÿæˆçš„é…ç½®è¡¨æ•°æ®æ–‡ä»¶ã€‚

### ğŸŒ 3. æœ¬åœ°åŒ–æ”¯æŒ

- **Create Localization csv**ï¼šæå–é…ç½®è¡¨ä¸­çš„æœ¬åœ°åŒ–å­—ç¬¦ä¸²ï¼ˆLocStringç±»å‹ï¼‰ï¼Œç”Ÿæˆ CSV æ–‡ä»¶ã€‚

### ğŸ“¥ 4. åŠ è½½é…ç½®

ä½¿ç”¨ `ConfigGroup` ç±»åŠ è½½æŒ‡å®šçš„é…ç½®è¡¨ï¼Œå¹¶åœ¨ä¸éœ€è¦æ—¶æ¸…é™¤é…ç½®è¡¨ç¼“å­˜ï¼š

```csharp
// äº‹ä»¶æ³¨å†Œå½¢å¼åŠ è½½ guidanceConf å’Œ guidanceConf
public void LoadConfig()
{
    ConfigGroup<CommonConfigLoader> configGroup = new ConfigGroup<CommonConfigLoader>(ConfigManager.instance.guidanceConf);
    configGroup.Append(ConfigManager.instance.rolePropConf);
    configGroup.onLoadCompleted += OnInitConfLoadCompleted;
    configGroup.LoadAll();
}

void OnInitConfLoadCompleted(AssetLoadStatus status)
{
    if (status == AssetLoadStatus.Loaded)
    {
        Debug.Log("é…ç½®åŠ è½½æˆåŠŸ");
    }
    else
    {
        Debug.LogError("é…ç½®åŠ è½½å¤±è´¥");
    }
}

// ä½¿ç”¨åç¨‹åŠ è½½
public void LoadConfigCoroutine()
{
    CoroutineRunner.StartCoroutine(LoadConfigCoroutineHandle());
}

void LoadConfigCoroutineHandle(AssetLoadStatus status)
{
    ConfigGroup<CommonConfigLoader> configGroup = new ConfigGroup<CommonConfigLoader>(ConfigManager.instance.guidanceConf);
    configGroup.Append(ConfigManager.instance.rolePropConf);
    configGroup.onLoadCompleted += OnInitConfLoadCompleted;
    yield return configGroup.LoadAll();

    if (configGroup.loadStatus == AssetLoadStatus.Loaded)
    {
        Debug.Log("é…ç½®åŠ è½½æˆåŠŸ");
    }
    else
    {
        Debug.LogError("é…ç½®åŠ è½½å¤±è´¥");
        string[] failed = configGroup.failLoadConfigs;
        for (var i = 0; i < failed.Length; i++)
        {
            Debug.LogError(failed[i] + "åŠ è½½å¤±è´¥")
        }
    }

    // æ¸…é™¤é…ç½®è¡¨ç¼“å­˜ï¼Œä¹‹åéœ€è¦å†é‡æ–°åŠ è½½
    configGroup.ReleaseAll();
}
```

### ğŸ“Š 5. è·å–é…ç½®æ•°æ®

é€šè¿‡ `ConfigManager` è·å–å…·ä½“é…ç½®è¡¨æ•°æ®ï¼š

```csharp
// é€šè¿‡keyè·å–ç‰¹å®šé…ç½®æ•°æ®
RolePropConf roleConfig = ConfigManager.instance.rolePropConf.Get(roleId);
Debug.Log($"è§’è‰²åç§°: {roleConfig.name}");

// è·å–å…¨éƒ¨é…ç½®æ•°æ®
List<RolePropConf> roleConfigList = ConfigManager.instance.rolePropConf.rawData;
// Do something with List<RolePropConf>...
foreach (var conf in roleConfigList)
{
    Debug.Log($"è§’è‰²åç§°: {conf.name}");
}

List<RolePropConf> matched = roleConfigList.Where(o => o.atk > 10 && o.atk < 20).ToList();
...
```

### ğŸ”§ 6. æ‰©å±•è‡ªå®šä¹‰ç±»å‹

ä¸‹é¢ä»¥ `TimeDateRef` ä¸ºä¾‹ï¼Œå‡è®¾ `TimeDateRef` ç±»å‹æ˜¯å°†é…ç½®è¡¨ä¸­çš„å­—ç¬¦ä¸²è½¬ä¸º `TimeDate`ï¼š
```csharp
[Serializable]
// è¿™ä¸ªæ˜¯é…ç½®è¡¨ç±»å‹çš„åŸºç±»
public abstract class TypeRef
{
    public abstract bool isMatch(string lowerRawType);
    
    public abstract string TypeName();
}

[Serializable]
// ç»§æ‰¿ TypeRef åŸºç±»
public sealed class TimeDateRef: TypeRef
{
    // å¿…é¡»å®ç°çš„æ¥å£ï¼Œç”Ÿæˆé…ç½®è¡¨C#ç±»æ—¶ä¼šè¯»å–è¡¨å¤´è¾“å…¥çš„ç±»å‹çš„å­—ç¬¦ä¸²ï¼Œä¼šå°†å­—ç¬¦ä¸²æ‰€æœ‰å­—ç¬¦è½¬ä¸ºå°å†™ã€‚
    // è½¬åŒ–çš„å­—ç¬¦ä¸²ä¼šä¼ å…¥è¿™ä¸ªæ–¹æ³•ï¼Œåˆ¤æ–­ç±»å‹æ˜¯å¦åŒ¹é…
    public override bool isMatch(string lowerRawType)
    {
        return lowerRawType.Equals("timedate");
    }

    // éœ€è¦è½¬æ¢çš„ç±»å‹åçš„å­—ç¬¦ä¸²ã€‚
    // å¯ä»¥è½¬åŒ–ä¸ºä½ éœ€è¦çš„ç±»å‹ï¼Œåªéœ€å†ä¸‹é¢çš„ Parse æ–¹æ³•å†…æä¾›æ­£ç¡®çš„è½¬åŒ–æ–¹å¼å³å¯ã€‚
    public override string TypeName()
    {
        return "TimeDate";
    }

    // å¿…è¦çš„é™æ€æ–¹æ³•ã€‚
    // è¿”å›çš„ç±»å‹ä¸ºç›®æ ‡çš„ç±»å‹ã€‚
    // å‚æ•° stringValue ä¸ºè¯»å–çš„Excelä¸­ï¼Œç¬¬ rowIndex è¡Œã€ç¬¬ colIndex åˆ—å•å…ƒæ ¼çš„å­—ç¬¦ä¸²æ•°æ®ã€‚
    // confName ä¸ºé…ç½®è¡¨åã€‚
    public static TimeDate Parse(string stringValue, string confName, int rowIndex, int colIndex)
    {
        // å‡è®¾ä¼ å…¥çš„æ•°æ®æ ¼å¼ä¸º "yyyy-mm-dd";
        if (string.IsNullOrEmpty(stringValue))
        {
            return default;
        }
        var splitString = stringValue.Split('-');
        var year = int.Parse(splitString[0]);
        var month = int.Parse(splitString[1]);
        var day = int.Parse(splitString[2]);

        var time = new TimeDate(year, month, day);
        return time;
    }
}
```
ä¹‹ååªéœ€è¦å†Excelä¸­ä½¿ç”¨ **TimeDate** ä½œä¸ºå­—æ®µç±»å‹ï¼Œå¹¶åœ¨å•å…ƒæ ¼å¡«å……æ­£ç¡®æ ¼å¼çš„æ•°æ®å³å¯ã€‚


## ğŸ“‘ Excel æ–‡ä»¶æ ¼å¼

1. ç¬¬ä¸€è¡Œï¼šå­—æ®µæ³¨é‡Šã€‚
2. ç¬¬äºŒè¡Œï¼šå­—æ®µåç§°ï¼ˆå¯ç”¨ `:key` æ ‡è®°ä¸»é”®ï¼‰ã€‚
3. ç¬¬ä¸‰è¡Œï¼šå­—æ®µç±»å‹ï¼ˆå¦‚ `int`ã€`string`ã€`float[]` ç­‰ï¼‰ã€‚
4. ç¬¬å››è¡ŒåŠä»¥åï¼šæ•°æ®å†…å®¹ã€‚

ç¤ºä¾‹ï¼š

| æ³¨é‡Š       | id | åç§°       | å±æ€§å€¼   |
|------------|--------|------------|----------|
| å­—æ®µåç§°   | id:key| name       | value    |
| å­—æ®µç±»å‹   | int    | string     | float[]  |
| æ•°æ®       | 1      | è‹±é›„       | 10,20,30 |
| æ•°æ®       | 2      | æ€ªç‰©       | 5,15,25  |

![CustomTypeExcelExample](img/CustomTypeExcelExample.png "Magic Gardens")

![MutiKeyExcelExample](img/MutiKeyExcelExample.png "Magic Gardens")

## âš ï¸ æ³¨æ„äº‹é¡¹

1. Excel æ–‡ä»¶éœ€ä¿å­˜ä¸º `.xlsx` æ ¼å¼ã€‚
2. ä¸»é”®å­—æ®µéœ€ä½¿ç”¨ `:key` æ ‡è®°ï¼Œæ”¯æŒå¤šä¸ªé”®ã€‚
3. æœ¬åœ°åŒ–å­—æ®µéœ€ä½¿ç”¨ `LocalizationStringRef` æˆ– `LocalizationAssetRef` ç±»å‹ã€‚
4. å­—æ®µåç§°å¯ä»¥é‡å¤ï¼ˆå­—æ®µç±»å‹å¿…é¡»ç›¸åŒï¼‰ï¼Œé‡å¤çš„å­—æ®µåœ¨ç”Ÿæˆæ—¶ä¼šè½¬ä¸ºList<T>ç±»å‹ï¼Œå¹¶å°†æœ‰å€¼çš„æ•°æ®å¡«å……è‡³List<T>ä¸­ã€‚

## ğŸ“¦ ä¾èµ–

- Unity 2020.3 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
- [EPPlus](https://github.com/EPPlusSoftware/EPPlus) ç”¨äºè§£æ Excel æ–‡ä»¶ã€‚
- [Newtonsoft.Json](https://www.newtonsoft.com/json) ç”¨äº JSON åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

## â“ å¸¸è§é—®é¢˜

1. **é…ç½®åŠ è½½å¤±è´¥**  
    æ£€æŸ¥è·¯å¾„è®¾ç½®æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿ Excel æ–‡ä»¶æ ¼å¼ç¬¦åˆè¦æ±‚ã€‚

2. **æœ¬åœ°åŒ–å­—ç¬¦ä¸²æœªæ­£ç¡®å¯¼å‡º**  
    ç¡®ä¿å­—æ®µç±»å‹ä¸º `LocString` (å¤§å°å†™å‡å¯)æˆ– `LocAsset` (å¤§å°å†™å‡å¯)ã€‚

3. **ç”Ÿæˆçš„é…ç½®ç±»å­—æ®µç¼ºå¤±**  
    æ£€æŸ¥ Excel æ–‡ä»¶çš„å­—æ®µåç§°å’Œç±»å‹æ˜¯å¦æ­£ç¡®å¡«å†™ã€‚

4. **ä¿®æ”¹å¯¼å‡ºè„šæœ¬åï¼Œç”Ÿæˆé…ç½®è¡¨èµ„äº§æ²¡æœ‰æ›´æ–°**
    ä¸ºäº†åŠ å¿«ç”Ÿæˆé€Ÿåº¦ï¼Œå·¥å…·ä¼šæ£€æŸ¥excelçš„MD5å€¼ï¼Œå¦‚æœåªä¿®æ”¹è„šæœ¬è€ŒExcelæ²¡æœ‰ä¿®æ”¹ï¼Œå·¥å…·ä¼šè·³è¿‡è¿™ä»½Excelã€‚
    å¯ä»¥ä½¿ç”¨ **Config Setting Window** ä¸Š **Delete Config Assets** æŒ‰é’®ï¼Œæˆ–è€…æ‰‹åŠ¨åˆ é™¤ç”Ÿæˆçš„é…ç½®è¡¨èµ„äº§ï¼Œé‡æ–°å¯¼å‡ºå³å¯ã€‚