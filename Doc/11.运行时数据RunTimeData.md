# è¿è¡Œæ—¶æ•°æ®ç®¡ç†å·¥å…·ç±» ğŸš€

## ç®€ä»‹ ğŸ“–

è¿™å¥—è¿è¡Œæ—¶æ•°æ®ç®¡ç†å·¥å…·ç±»æ—¨åœ¨æä¾›ä¸€ç§é«˜æ•ˆã€çµæ´»çš„æ–¹å¼æ¥ç®¡ç†æ¸¸æˆä¸­çš„è¿è¡Œæ—¶æ•°æ®ã€‚é€šè¿‡ä½¿ç”¨æ³›å‹å’Œå§”æ‰˜ï¼Œå®ƒæ”¯æŒå¤šç§æ•°æ®å­˜å‚¨å½¢å¼ï¼ˆå¦‚å•ä¸€æ•°æ®ã€å­—å…¸æ•°æ®ç­‰ï¼‰ï¼Œå¹¶æä¾›äº†ç›‘å¬æ•°æ®å˜åŒ–çš„èƒ½åŠ›ï¼Œä¾¿äºå¼€å‘è€…åœ¨æ•°æ®æ›´æ–°æ—¶è§¦å‘ç›¸å…³é€»è¾‘ã€‚

## âœ¨ç‰¹ç‚¹ 

1. **å¤šç§æ•°æ®å­˜å‚¨å½¢å¼**ï¼š
   - å•ä¸€æ•°æ®å®¹å™¨ï¼ˆ`RuntimeData<T>`ï¼‰
   - å­—å…¸æ•°æ®å®¹å™¨ï¼ˆ`RuntimeDataDic<K, T>`ï¼‰

2. **æ•°æ®å˜åŒ–ç›‘å¬**ï¼š
   - æ”¯æŒé€šè¿‡å§”æ‰˜ç›‘å¬æ•°æ®å˜åŒ–ï¼Œä¾¿äºå®æ—¶å“åº”ã€‚

3. **æ¨¡å—åŒ–è®¾è®¡**ï¼š
   - æ•°æ®å­˜å‚¨ä¸ç®¡ç†é€»è¾‘åˆ†ç¦»ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤ã€‚

4. **æ”¯æŒæ¸¸æˆé‡å¯æ•°æ®æŒä¹…åŒ–**ï¼š
   - æä¾›äº†ä¸¤ç§å­˜å‚¨æ–¹å¼ï¼šæ™®é€šå­˜å‚¨å’Œä¸ä¼šéšæ¸¸æˆé‡å¯æ¸…é™¤çš„å­˜å‚¨ã€‚

5. **æ˜“äºæ‰©å±•**ï¼š
   - å¯é€šè¿‡ç»§æ‰¿å’Œæ³›å‹è½»æ¾æ‰©å±•æ–°çš„æ•°æ®ç±»å‹ã€‚

## ğŸ”§åŠŸèƒ½ 

- æ·»åŠ ã€è·å–ã€æ›¿æ¢ã€åˆ é™¤è¿è¡Œæ—¶æ•°æ®ã€‚
- æ”¯æŒç›‘å¬æ•°æ®å˜åŒ–ã€‚
- æä¾›å­—å…¸å½¢å¼çš„æ•°æ®å­˜å‚¨ï¼Œæ”¯æŒæŒ‰é”®å€¼æ“ä½œã€‚
- æä¾›å·¥å…·ç±»ï¼ˆå¦‚ `BagUtils`ï¼‰ç®€åŒ–å¸¸ç”¨æ“ä½œã€‚

## ğŸ› ï¸ä½¿ç”¨æ–¹æ³• 

### 1. åˆå§‹åŒ–è¿è¡Œæ—¶æ•°æ®ç®¡ç†å™¨

åœ¨æ¸¸æˆå¯åŠ¨æ—¶ï¼Œè°ƒç”¨ `RuntimeDataManager` çš„åˆå§‹åŒ–æ–¹æ³•ï¼š

```csharp
RuntimeDataManager.instance.OnInit();
RuntimeDataManager.instance.RegisterEvent();
```

### 2. â•æ·»åŠ è¿è¡Œæ—¶æ•°æ® 

ä½¿ç”¨ `AddRuntimeData` æ–¹æ³•æ·»åŠ è¿è¡Œæ—¶æ•°æ®ï¼š

```csharp
var bagData = new RuntimeDataManager_Bag.BagData();
RuntimeDataManager.instance.AddRuntimeData(bagData);
```

### 3. ğŸ”è·å–è¿è¡Œæ—¶æ•°æ® 

é€šè¿‡æ³›å‹æ–¹æ³• `GetRuntimeData<T>` è·å–è¿è¡Œæ—¶æ•°æ®ï¼š

```csharp
var bag = RuntimeDataManager.instance.GetRuntimeData<RuntimeDataManager_Bag.BagData>();
```

### 4. ğŸ‘œä½¿ç”¨ `BagUtils` ç¤ºä¾‹ 

### æ„å»ºæ•°æ®æ ¼å¼

```csharp
namespace PowerCellStudio
{
   // å®šä¹‰é“å…·çš„æ•°æ®ç»“æ„ï¼Œéœ€è¦çš„å±æ€§æœ‰ id å’Œæ•°é‡
   public class RItem: ICloneT<RItem>
   {
      public int id;
      public int num;

      // å®ç° Clone æ–¹æ³•
      public RItem Clone()
      {
         return new RItem()
         {
               id = this.id,
               num = this.num
         };
      }
   }

   // RuntimeDataManager æ˜¯ä¸ª partial ç±»ï¼Œå¯ä»¥å¦å»ºä¸€ä¸ªæ–‡ä»¶æ–¹ä¾¿ä»£ç ç®¡ç†
   public partial class RuntimeDataManager
   {
      // å£°æ˜èƒŒåŒ…æ•°æ®ï¼Œä½¿ç”¨äº†å­—å…¸ç±»å‹çš„RuntimeDataç»“æ„ä¿å­˜é“å…·æ•°æ®ï¼Œé“å…·idä½œä¸ºkey
      private sealed class BagData : RuntimeDataDic<int, RItem> { }

      // åˆå§‹åŒ–èƒŒåŒ…çš„æ–¹æ³•ï¼Œåœ¨ RuntimeDataManager è°ƒç”¨å‰è°ƒç”¨è¿™ä¸ªæ–¹æ³•
      public void InitBag()
      {
         if(GetRuntimeData<BagData>() != null) return;
         var bagData = new BagData();

         // æ­¤ä¸ºä¸¾ä¾‹ã€‚æ³¨å†ŒèƒŒåŒ…é“å…·æ›´æ–°çš„äº‹ä»¶ã€‚
         bagData.AddListener(OnItemChange);

         // å°†èƒŒåŒ…æ•°æ®åŠ å…¥ RuntimeDataManager ä¸­ã€‚
         AddRuntimeData(bagData);
      }

      // ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ä¸ºå¯¹èƒŒåŒ…ä¸­çš„æ•°æ®è¿›è¡Œæ·»åŠ /ä¿®æ”¹
      
      public void AddItem(RItem rItem)
      {
         if (rItem == null) return;
         // è·å–èƒŒåŒ…æ•°æ®
         var bag = GetRuntimeData<BagData>();
         // åœ¨å®¹å™¨ä¸­é€šè¿‡é“å…·idæŸ¥æ‰¾ç°æœ‰æ•°æ®
         var currentNum = bag?.GetData(rItem.id)?.num ?? 0;
         // ä¿®æ”¹é“å…·æ•°é‡
         rItem.num = currentNum + rItem.num;
         // ä½¿ç”¨ ReplaceData() æ–¹æ³•æ›¿æ¢åŸæœ‰çš„æ•°æ®
         bag?.ReplaceData(rItem.id, rItem);
      }

      public void RemoveItem(RItem rItem)
      {
         if (rItem == null) return;
         var bag = GetRuntimeData<BagData>();
         var current = bag?.GetData(rItem.id);
         if (current == null) return;
         current.num -= rItem.num;
         current.num = Math.Max(0, current.num);
         bag.ReplaceData(rItem.id, current);

         // åœ¨æ•°é‡ä¸º0æ—¶ï¼Œä»å®¹å™¨ä¸­ç§»é™¤æ•°æ®
         if (current.num == 0)
               bag?.Remove(rItem.id);
      }

      public int GetItemNumber(int id)
      {
         var bag = GetRuntimeData<BagData>();
         return bag?.GetData(id)?.num ?? 0;
      }

      // ç±»å¤–éƒ¨æ·»åŠ èƒŒåŒ…æ•°æ®ç›‘å¬çš„æ–¹å¼
      // å¿…é¡»é€šè¿‡ GetRuntimeData<T>() è·å¾—æ•°æ®å®¹å™¨
      public void AddBagListener(OnRuntimeDataChange<RItem> action)
      {
         GetRuntimeData<BagData>()?.AddListener(action);
      }
      
      public void RemoveBagListener(OnRuntimeDataChange<RItem> action)
      {
         GetRuntimeData<BagData>()?.RemoveListener(action);
      }
      
      public List<RItem> GetAllItems()
      {
         var bag = GetRuntimeData<BagData>();
         return bag?.ToList()?? new List<RItem>();
      }

      private void OnItemChange(RItem oldData, RItem newData)
      {
         ModuleLog<BagUtils>.Log($"item id = {newData.id}, item number = {newData.num}.");
      }
   }
}
```

#### â•æ·»åŠ ç‰©å“ 

```csharp
BagUtils.AddItem(new RItem { id = 1, num = 10 });
BagUtils.AddItem(2, 5); // æ·»åŠ idä¸º2çš„ç‰©å“ï¼Œæ•°é‡ä¸º5
```

#### â–ç§»é™¤ç‰©å“

```csharp
BagUtils.RemoveItem(new RItem { id = 1, num = 5 });
BagUtils.RemoveItem(2, 3); // ç§»é™¤idä¸º2çš„ç‰©å“ï¼Œæ•°é‡ä¸º3
```

#### ğŸ“¦è·å–ç‰©å“æ•°é‡ 

```csharp
int itemNum = BagUtils.GetItemNum(1); // è·å–idä¸º1çš„ç‰©å“æ•°é‡
```

#### âœ…åˆ¤æ–­ç‰©å“æ˜¯å¦è¶³å¤Ÿ 

```csharp
bool isEnough = BagUtils.IsItemEnough(1, 10); // åˆ¤æ–­idä¸º1çš„ç‰©å“æ˜¯å¦è‡³å°‘æœ‰10ä¸ª
```

#### ğŸ””æ·»åŠ ç›‘å¬å™¨

```csharp
BagUtils.AddBagListener((oldItem, newItem) =>
{
    Console.WriteLine($"ç‰©å“å˜åŒ–: id={newItem.id}, æ•°é‡={newItem.num}");
});
```

### 5. ğŸ‘‚æ•°æ®å˜åŒ–ç›‘å¬ 

é€šè¿‡ `AddListener` æ–¹æ³•ç›‘å¬æ•°æ®å˜åŒ–ï¼š

```csharp
var bag = RuntimeDataManager.instance.GetRuntimeData<RuntimeDataManager_Bag.BagData>();
bag?.AddListener((oldItem, newItem) =>
{
    Console.WriteLine($"ç‰©å“å˜åŒ–: id={newItem.id}, æ•°é‡={newItem.num}");
});
```

### 6. ğŸ§¹æ¸…ç†è¿è¡Œæ—¶æ•°æ® 

åœ¨æ¸¸æˆé‡ç½®æ—¶ï¼Œè°ƒç”¨ `ClearRuntimeData` æ–¹æ³•æ¸…ç†è¿è¡Œæ—¶æ•°æ®ï¼š

```csharp
RuntimeDataManager.instance.ClearRuntimeData();
```

## âš ï¸æ³¨æ„äº‹é¡¹ 

1. **æ•°æ®ç±»å‹è¦æ±‚**ï¼š
   - æ•°æ®ç±»å‹å¿…é¡»å®ç° `ICloneT<T>` æ¥å£ï¼Œä»¥æ”¯æŒæ•°æ®å…‹éš†æ“ä½œã€‚
   - å­—å…¸æ•°æ®çš„é”®å€¼ç±»å‹éœ€æ»¡è¶³å­—å…¸çš„é”®å€¼è¦æ±‚ï¼ˆå¦‚å®ç° `GetHashCode` å’Œ `Equals` æ–¹æ³•ï¼‰ã€‚

2. **ç›‘å¬å™¨çš„ç®¡ç†**ï¼š
   - åœ¨æ·»åŠ ç›‘å¬å™¨æ—¶ï¼Œç¡®ä¿åœ¨é€‚å½“æ—¶æœºç§»é™¤ç›‘å¬å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

3. **æ•°æ®å­˜å‚¨çš„é€‰æ‹©**ï¼š
   - æ™®é€šå­˜å‚¨çš„æ•°æ®ä¼šåœ¨æ¸¸æˆé‡å¯æ—¶æ¸…é™¤ã€‚
   - ä½¿ç”¨ `doNotClear` å‚æ•°å°†æ•°æ®å­˜å‚¨åˆ°ä¸ä¼šæ¸…é™¤çš„å­˜å‚¨ä¸­ã€‚

4. **çº¿ç¨‹å®‰å…¨**ï¼š
   - å½“å‰å®ç°æœªè€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼Œè‹¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œè¯·è‡ªè¡Œæ·»åŠ åŒæ­¥æœºåˆ¶ã€‚